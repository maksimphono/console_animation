#!/bin/bash

set -euo pipefail

APP_NAME=console_video

#mkdir "$HOME/.local/share/$APP_NAME"
CONFIG_FILE="../config"


check_argument() {
    if [[ ! -n "$2" || "$2" =~ ^- ]]; then
        echo "Error: Argument for $1 is missing or invalid."
        exit 1
    fi
}

STORAGE_PATH="$HOME/.local/share/console_video/.storage" #default storage location

LIST_FILES=0
NAME=""
FPS="2"
SIZE="66x19"
TIME="0-5"

INPUT_PATH=""
INPUT_PATH_EXTENSION=""
INPUT_NAME=""
INPUT_DIR_PATH=""

source $CONFIG_FILE # load configuration

args=( "-v $STORAGE_PATH:/home/storage" )

while [[ "$#" -gt 0 ]]; do
    case "$1" in
        -l)
            args+=( "-e LIST_FILES=1")
            break
            ;;
        -i)
            $(check_argument $1 $2)
            INPUT_PATH=$2
            INPUT_PATH_EXTENSION="${INPUT_PATH##*.}"
            INPUT_NAME=$(basename "$INPUT_PATH")
            INPUT_DIR_PATH=$(dirname "$INPUT_PATH")
            
            args+=( "-e INPUT_PATH=/data/$INPUT_NAME" )
            args+=( "-v $INPUT_DIR_PATH:/data/" )
            shift 
            ;;
        -n)
            $(check_argument $1 $2)
            args+=( "-e NAME=$2" )
            break
            ;;
        -f)
            $(check_argument $1 $2)
            FPS=$2
            shift 
            ;;
        -s)
            $(check_argument $1 $2)
            SIZE=$2
            shift 
            ;;
        -t)
            $(check_argument $1 $2)
            TIME=$2
            shift 
            ;;
        *)
    esac
    shift
done


docker run \
    -it \
    --rm \
    ${args[@]} \
    -e FPS=$FPS \
    -e SIZE=$SIZE \
    -e TIME=$TIME \
    console_video_prod:latest

#-e INPUT_PATH="/data/${INPUT_NAME}" \
#-v "${INPUT_DIR_PATH}:/data/" \

#-e LIST_FILES=$LIST_FILES \
#    -e NAME='' \
#    -e FPS=$FPS \
#    -e SIZE=$SIZE \
#    -e TIME=$TIME \
#    -e INPUT_PATH="/data/$INPUT_NAME" \
#-v "$INPUT_DIR_PATH:/data/" \
#    -v "/home/trukhinmaksim/Maksim/Projects/cli/01_console_video/build/storage:/home/storage" \


# ${args[@]}
#if [[ ! -f "$INPUT_PATH" ]]; then
#    echo "Provided file $INPUT_PATH can't be found"
#    exit 1
#fi
#if [[ ! "$INPUT_PATH_EXTENSION" == "mp4" ]]; then
#    echo "Provided file format $INPUT_PATH_EXTENSION isn't supported. Supported formats: mp4"
#    exit 1
#fi
#
#shift
#ORIGINAL_ARGS=("$@")
#IMG_OUTPUT_PATH="$INPUT_DIR_NAME.png"
#
#
#IMG_OUTPUT_DIR_PATH=$(dirname "$IMG_OUTPUT_PATH")
#IMG_OUTPUT_NAME=$(basename "$IMG_OUTPUT_PATH")
#IMG_OUTPUT_EXTENSION="${IMG_OUTPUT_NAME##*.}"
#
#if [[ ! "$IMG_OUTPUT_EXTENSION" == "png" && \
#      ! "$IMG_OUTPUT_EXTENSION" == "jpg" && \
#      ! "$IMG_OUTPUT_EXTENSION" == "jpeg" && \
#      ! "$IMG_OUTPUT_EXTENSION" == "svg" ]]; then
#    echo "Sorry, only following formats are supported: png, jpg, jpeg, svg"
#    IMG_OUTPUT_EXTENSION="png"
#fi
#
#CODE_CREATOR_PATH="./code_creator.o"
#PLANTUML_JAR_PATH="/home/dist/plantuml.jar"
#
#COMMAND="$CODE_CREATOR_PATH /data/$INPUT_DIR_NAME ${ORIGINAL_ARGS[@]} | java -Djava.awt.headless=true -jar $PLANTUML_JAR_PATH -t$IMG_OUTPUT_EXTENSION -pipe > /output/$IMG_OUTPUT_NAME"